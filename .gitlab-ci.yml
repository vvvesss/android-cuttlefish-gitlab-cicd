# Lightweight Android pipeline with smaller image
stages:
  - build
  - test

variables:
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

# Use smaller Android image
build_debug_android:
  stage: build
  image: javiersantos/android-ci:api-34
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper
      - .gradle/caches
  before_script:
    - echo "📱 Android environment ready"
    - echo "ANDROID_HOME=$ANDROID_HOME"
    - java -version
  script:
    - echo "🔧 Building debug APK..."
    - chmod +x gradlew
    - ./gradlew assembleDebug --no-daemon --stacktrace
    - echo "✅ Build successful!"
    - ls -la app/build/outputs/apk/debug/
  artifacts:
    paths:
      - app/build/outputs/apk/debug/
    expire_in: 1 hour

# Simple test stage
test_simple:
  stage: test
  image: javiersantos/android-ci:api-34
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper
      - .gradle/caches
  script:
    - echo "🧪 Running tests..."
    - ./gradlew test --no-daemon
    - echo "✅ Tests completed!"
  dependencies:
    - build_debug_android

# Test GCP connection
test_gcp_connection:
  stage: test
  image: google/cloud-sdk:alpine
  before_script:
    - echo $GCP_SERVICE_ACCOUNT_KEY | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file /tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
  script:
    - echo "🔐 Testing GCP connection..."
    - gcloud compute zones list --limit=5
    - echo "✅ GCP connection successful!"
  only:
    - main
