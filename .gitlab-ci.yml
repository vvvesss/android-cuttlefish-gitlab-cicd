# Optimized .gitlab-ci.yml with Android image
stages:
  - build
  - test

variables:
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

# Use pre-built Android image for faster builds
build_debug_android:
  stage: build
  image: mingc/android-build-box:latest
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper
      - .gradle/caches
  before_script:
    - echo "ğŸ“± Android environment ready"
    - echo "ANDROID_HOME=$ANDROID_HOME"
    - echo "JAVA_HOME=$JAVA_HOME"
    - java -version
    - gradle --version
  script:
    - echo "ğŸ”§ Building debug APK..."
    - chmod +x gradlew
    - ./gradlew assembleDebug --no-daemon --stacktrace
    - echo "âœ… Build successful!"
    - ls -la app/build/outputs/apk/debug/
  artifacts:
    paths:
      - app/build/outputs/apk/debug/
    expire_in: 1 hour

# Simple test stage
test_simple:
  stage: test
  image: mingc/android-build-box:latest
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper
      - .gradle/caches
  script:
    - echo "ğŸ§ª Running tests..."
    - ./gradlew test --no-daemon
    - echo "âœ… Tests completed!"
  dependencies:
    - build_debug_android

# Test GCP connection (without creating resources)
test_gcp_connection:
  stage: test
  image: google/cloud-sdk:alpine
  before_script:
    - echo $GCP_SERVICE_ACCOUNT_KEY | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file /tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
  script:
    - echo "ğŸ” Testing GCP connection..."
    - gcloud compute zones list --limit=5
    - echo "âœ… GCP connection successful!"
  only:
    - main