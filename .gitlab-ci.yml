# Simplified .gitlab-ci.yml for initial testing
stages:
  - build
  - test

variables:
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

# Test basic build without signing
build_debug_simple:
  stage: build
  image: gradle:7.5.1-jdk11
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper
      - .gradle/caches
  script:
    - echo "🔧 Building debug APK..."
    - ./gradlew assembleDebug
    - echo "✅ Build successful!"
    - ls -la app/build/outputs/apk/debug/
  artifacts:
    paths:
      - app/build/outputs/apk/debug/
    expire_in: 1 hour

# Test basic unit tests
test_simple:
  stage: test
  image: gradle:7.5.1-jdk11
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .gradle/wrapper
      - .gradle/caches
  script:
    - echo "🧪 Running tests..."
    - ./gradlew test
    - echo "✅ Tests completed!"
  dependencies:
    - build_debug_simple

# Test GCP connection (without creating resources)
test_gcp_connection:
  stage: test
  image: google/cloud-sdk:alpine
  before_script:
    - echo $GCP_SERVICE_ACCOUNT_KEY | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file /tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
  script:
    - echo "🔐 Testing GCP connection..."
    - gcloud compute zones list --limit=5
    - echo "✅ GCP connection successful!"
  only:
    - main